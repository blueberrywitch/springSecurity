<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Пользователи</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        body {
            padding-top: 20px;
        }
        #notification {
            margin-bottom: 20px;
        }
        .photo-img {
            width: 100px;
            height: auto;
            border-radius: 50%;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h2>Список пользователей</h2>
    <!-- Блок с кнопками входа/выхода -->
    <div class="mb-3">
        <div sec:authorize="!isAuthenticated()">
            <button class="btn btn-outline-primary" onclick="window.location.href='/login'">
                Войти или зарегистрироваться
            </button>
        </div>
        <div sec:authorize="isAuthenticated()">
            <button class="btn btn-outline-danger" onclick="window.location.href='/login/logout'">
                Выйти
            </button>
        </div>
    </div>
    <!-- Блок уведомлений -->
    <div id="notification" class="alert" style="display:none;" role="alert"></div>
    <!-- Таблица пользователей (итерация по Map) -->
    <table class="table table-bordered" id="usersTable">
        <thead>
        <tr>
            <th>Фото</th>
            <th>Имя пользователя</th>
            <th>Ссылки</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="entry : ${userPhotos}">
            <!-- Колонка с фото: здесь можно оставить, как было, например, показываются фото из LinksDto -->
            <td>
                <div style="display: flex; flex-direction: row; gap: 10px;">
                    <img th:if="${entry.value.vk != null and !#strings.isEmpty(entry.value.vk)}"
                         th:src="${entry.value.vk}"
                         alt="Фото VK"
                         class="photo-img"/>
                    <img th:if="${entry.value.tg != null and !#strings.isEmpty(entry.value.tg)}"
                         th:src="${entry.value.tg}"
                         alt="Фото Telegram"
                         class="photo-img"/>
                </div>
            </td>
            <!-- Колонка с именем пользователя -->
            <td th:text="${entry.key.username}"></td>
            <!-- Колонка со ссылками, получаем ссылки из user.linksEntity -->
            <td>
                <div>
                    <span>VK: </span>
                    <a th:if="${entry.key.linksEntity != null and entry.key.linksEntity.vkRef != null and !#strings.isEmpty(entry.key.linksEntity.vkRef)}"
                       th:href="${entry.key.linksEntity.vkRef}"
                       th:text="${entry.key.linksEntity.vkRef}"></a>
                    <span th:if="${entry.key.linksEntity == null or entry.key.linksEntity.vkRef == null or #strings.isEmpty(entry.key.linksEntity.vkRef)}">-</span>
                </div>
                <div>
                    <span>Telegram: </span>
                    <a th:if="${entry.key.linksEntity != null and entry.key.linksEntity.tgRef != null and !#strings.isEmpty(entry.key.linksEntity.tgRef)}"
                       th:href="${entry.key.linksEntity.tgRef}"
                       th:text="${entry.key.linksEntity.tgRef}"></a>
                    <span th:if="${entry.key.linksEntity == null or entry.key.linksEntity.tgRef == null or #strings.isEmpty(entry.key.linksEntity.tgRef)}">-</span>
                </div>
                <!-- Если в LinksEntity есть другие ссылки (например, Instagram или VK-паблик) можно добавить ещё блоки -->
            </td>
            <!-- Колонка с действиями -->
            <td>
                <div th:if="${username != null and (username == entry.key.username or isAdmin)}">
                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteUser()">Удалить</button>
                    <button type="button" class="btn btn-primary btn-sm edit-user-btn"
                            th:attr="data-externalid=${entry.key.externalId},
                                 data-id=${entry.key.id},
                                 data-username=${entry.key.username},
                                 data-password=${entry.key.password},
                                 data-vkref=${entry.key.linksEntity != null ? entry.key.linksEntity.vkRef : ''},
                                 data-tgref=${entry.key.linksEntity != null ? entry.key.linksEntity.tgRef : ''}"
                            data-toggle="modal" data-target="#editUserModal">
                        Изменить
                    </button>
                </div>
            </td>
        </tr>
        </tbody>



    </table>
</div>

<!-- Модальное окно для редактирования пользователя -->
<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="editUserForm" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">Редактирование пользователя</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="editUserId">
                    <div class="form-group">
                        <label for="editUsername">Username</label>
                        <input type="text" class="form-control" name="username" id="editUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="editPassword">Password</label>
                        <input type="text" class="form-control" name="password" id="editPassword" required>
                    </div>
                    <hr>
                    <h6>Ссылки</h6>
                    <div class="form-group">
                        <label for="editTgRef">Telegram</label>
                        <input type="text" class="form-control" name="linksEntityDTO.tgRef" id="editTgRef">
                    </div>
                    <div class="form-group">
                        <label for="editInstRef">Instagram</label>
                        <input type="text" class="form-control" name="linksEntityDTO.instRef" id="editInstRef">
                    </div>
                    <div class="form-group">
                        <label for="editVkRef">VK</label>
                        <input type="text" class="form-control" name="linksEntityDTO.vkRef" id="editVkRef">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить изменения</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Подключение необходимых JS библиотек -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.className = "alert alert-" + type;
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        const editButtons = document.querySelectorAll('.edit-user-btn');
        const editUserForm = document.getElementById('editUserForm');

        editButtons.forEach(button => {
            button.addEventListener('click', function () {
                const id = button.getAttribute('data-id');
                const externalId = button.getAttribute('data-externalid');
                const username = button.getAttribute('data-username');
                const password = button.getAttribute('data-password');
                const tgRef = button.getAttribute('data-tgref');
                const instRef = button.getAttribute('data-instref');
                const vkRef = button.getAttribute('data-vkref');

                document.getElementById('editUserId').value = id;
                document.getElementById('editUsername').value = username;
                document.getElementById('editPassword').value = password;
                document.getElementById('editTgRef').value = tgRef;
                document.getElementById('editInstRef').value = instRef;
                document.getElementById('editVkRef').value = vkRef;

                editUserForm.setAttribute('action', '/user/update/' + externalId);
            });
        });

        editUserForm.addEventListener('submit', function (event) {
            event.preventDefault();
            const formData = new FormData(editUserForm);
            const externalId = editUserForm.getAttribute('action').split('/').pop();

            fetch('/user/update/' + externalId, {
                method: 'PUT',
                body: new URLSearchParams(formData)
            })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    } else {
                        throw new Error('Ошибка обновления');
                    }
                })
                .then(() => {
                    showNotification('Пользователь обновлен успешно', 'success');
                    location.reload();
                })
                .catch(error => {
                    console.error(error);
                    showNotification(error.message, 'danger');
                });
        });

        function deleteUser() {
            if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
                fetch('/user/delete', { method: 'DELETE' })
                    .then(resp => {
                        if (resp.ok) {
                            showNotification('Пользователь успешно удален', 'success');
                            location.reload();
                        } else {
                            throw new Error('Ошибка при удалении пользователя');
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка при удалении пользователя:', error);
                        showNotification(error.message || 'Ошибка при удалении пользователя', 'danger');
                    });
            }
        }
        window.deleteUser = deleteUser;
    });
</script>
</body>
</html>
